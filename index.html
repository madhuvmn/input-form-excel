<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Entry Form AND Export ‚Üí Excel (unsaved highlight)</title>
  <style>
    :root{
      --accent:#0b74de; --muted:#6b7280; --bg:#f3f6fb; --card:#ffffff;
      --danger:#d9534f; --input-border:#e6eef8; --unsaved:#fff7e6;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:var(--bg); color:#111827; padding:14px; }
    .container{ max-width:1100px; margin:0 auto; }
    header{ text-align:center; margin-bottom:14px; }
    header h1{ margin:0; font-size:20px; font-weight:800; }
    .card{ background:var(--card); border-radius:10px; padding:12px; box-shadow:0 6px 16px rgba(12,24,48,0.06); margin-bottom:12px; }
    .form-area{ display:flex; flex-direction:column; gap:10px; }
    .row-input{ display:grid; grid-template-columns: 48px 80px 140px 1fr 1fr 1fr 120px; gap:8px; align-items:end; padding:8px; border-radius:8px; background:#fbfdff; }
    .row-input + .row-input{ border-top:1px dashed #eef4fb; }
    .serial-badge{ display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--muted); font-size:14px; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
    input[type="number"], input[type="date"], input[type="text"]{ width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--input-border); background:white; font-size:14px; }
    input[readonly]{ background:#f8fafc; }
    .field{ display:flex; flex-direction:column; }
    .actions-row{ display:flex; gap:8px; align-items:center; margin-top:8px; flex-wrap:wrap; }
    button{ padding:10px 14px; border-radius:8px; border:0; background:var(--accent); color:white; font-weight:700; cursor:pointer; }
    button.ghost{ background:transparent; border:1px solid #dfe8f5; color:#111827; font-weight:700; }
    button.warn{ background:var(--danger); }
    button.small{ padding:8px 10px; font-size:13px; }
    .controls-left{ display:flex; gap:8px; align-items:center; }
    .controls-right{ margin-left:auto; display:flex; gap:8px; align-items:center; }
    .table-wrap{ overflow:auto; margin-top:10px; }
    table{ width:100%; border-collapse:collapse; min-width:700px; font-size:14px; }
    th,td{ text-align:left; padding:10px 12px; border-bottom:1px solid #eef3fb; vertical-align:middle; }
    th{ background:#f6fbff; font-weight:800; font-size:13px; position:sticky; top:0; z-index:2; }
    td.actions{ white-space:nowrap; width:1px; }
    .inline-error{ color:var(--danger); font-size:12px; margin-top:4px; display:block; }
    .small-muted{ font-size:12px; color:var(--muted) }
    .file-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .file-input{ padding:8px 10px; background:#fff; border-radius:8px; border:1px solid var(--input-border); }
    .unsaved-row{ background: var(--unsaved); } /* highlight for imported but unsaved rows */
    @media (max-width:880px){
      .row-input{ grid-template-columns: 48px 70px 1fr 1fr; grid-auto-rows: auto; gap:6px; }
      .row-input > .col-amount{ grid-column: 1 / -1; }
      .row-input > .col-actions{ grid-column: 1 / -1; justify-self:end; }
    }
    @media (max-width:520px){
      header h1{ font-size:18px; } .row-input{ grid-template-columns: 1fr; } .row-input > .col-actions{ justify-self:start; } table{ min-width:520px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header><h1>Entry Form AND Export ‚Üí Excel</h1></header>

    <section class="card" aria-labelledby="form-title">
      <div id="form-title" style="font-weight:700; margin-bottom:10px">Add new entries (add multiple rows, then click Save)</div>

      <div style="margin-bottom:10px" class="file-row">
        <!-- single file input; selecting a file auto-loads into the table preview -->
        <input id="file-input" class="file-input" type="file" accept=".xlsx,.xls,.csv" />
        <div id="file-info" class="small-muted" style="margin-left:auto"></div>
      </div>

      <div class="form-area" id="form-area"></div>

      <div class="actions-row">
        <div class="controls-left">
          <button id="btn-add-row" class="small">Ôºã Add Row</button>
          <button id="btn-clear-form" class="ghost small">Clear form</button>
        </div>
        <div class="controls-right">
          <button id="btn-save" style="background:#0b74de;">üíæ Save</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px">
        <div class="small-muted">Table preview (imported or saved rows appear here)</div>
        <div class="controls-right" style="margin-left:auto">
          <button id="btn-download-xlsx" class="small">‚¨áÔ∏è Download Excel (.xlsx)</button>
          <button id="btn-delete-all" class="warn small">Delete all</button>
        </div>
        <div id="rows-count" class="small-muted" style="margin-left:10px"></div>
      </div>

      <div class="table-wrap">
        <table id="data-table" role="table" aria-label="Data table">
          <thead id="table-head"></thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </section>

    <footer style="text-align:center; color:var(--muted); font-size:13px; margin-top:8px">
      Tip: Imported rows are highlighted until you click Save. Dates display as dd-mm-yyyy.
      <div style="margin-top:6px; font-size:12px">Uploaded file (local path): <a href="/mnt/data/8a298ec1-3e7e-4c62-a50e-19da2a3e0cf6.png" target="_blank">/mnt/data/8a298ec1-3e7e-4c62-a50e-19da2a3e0cf6.png</a></div>
    </footer>
  </div>

  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

  <script>
    // In-memory preview rows
    // Each row: { id, date (ISO yyyy-mm-dd), quantity, percentage, amount, saved: true/false }
    let rows = [];
    let nextFormId = 1;

    // DOM refs
    const formArea = document.getElementById('form-area');
    const fileInput = document.getElementById('file-input');
    const fileInfo = document.getElementById('file-info');
    const btnAddRow = document.getElementById('btn-add-row');
    const btnSave = document.getElementById('btn-save');
    const btnClearForm = document.getElementById('btn-clear-form');
    const btnDeleteAll = document.getElementById('btn-delete-all');
    const btnDownload = document.getElementById('btn-download-xlsx');
    const tableHead = document.getElementById('table-head');
    const tableBody = document.getElementById('table-body');
    const rowsCount = document.getElementById('rows-count');

    // Utilities
    function formatNumber(n){ if (!isFinite(n)) return ''; return (Math.round(n * 100) / 100).toFixed(2); }
    function isoFromDate(d){ const yyyy = d.getFullYear(); const mm = String(d.getMonth()+1).padStart(2,'0'); const dd = String(d.getDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
    function displayDateFromISO(iso){ if(!iso) return ''; const m = String(iso).match(/^(\d{4})-(\d{2})-(\d{2})$/); if(!m) return String(iso); return `${m[3]}-${m[2]}-${m[1]}`; }

    // parse flexible values into ISO yyyy-mm-dd
    function parseDateToISO(value){
      if (value instanceof Date && !isNaN(value)) return isoFromDate(value);
      if (typeof value === 'number') {
        const epoch = new Date(Date.UTC(1899,11,30));
        const d = new Date(epoch.getTime() + value * 24*60*60*1000);
        if (!isNaN(d)) return isoFromDate(d);
      }
      const s = String(value||'').trim();
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      const parsed = Date.parse(s);
      if (!isNaN(parsed)) return isoFromDate(new Date(parsed));
      const m = s.match(/^(\d{1,2})[\/\-\.\s](\d{1,2})[\/\-\.\s](\d{2,4})$/);
      if (m){
        let dd = Number(m[1]), mm = Number(m[2]), yy = Number(m[3]);
        if (yy < 100) yy += 2000;
        const d = new Date(yy, mm-1, dd);
        if (!isNaN(d)) return isoFromDate(d);
      }
      return s;
    }

    // Validations
    function validateId(v){ if (v === '' || v === null || v === undefined) return 'ID is required.'; if (!/^[-+]?\d+$/.test(String(v))) return 'ID must be an integer.'; const n = Number(v); if (!Number.isInteger(n)) return 'ID must be an integer.'; if (n < 0 || n > 21) return 'ID must be between 0 and 21.'; return ''; }
    function validateDate(v){ if (!v) return 'Date is required.'; return ''; } // internal iso expected
    function validateQty(v){ if (v === '' || v === null || v === undefined) return 'Quantity is required.'; const n = Number(v); if (isNaN(n)) return 'Quantity must be a number.'; if (!(n > 0)) return 'Quantity must be greater than 0.0.'; return ''; }
    function validatePct(v){ if (v === '' || v === null || v === undefined) return 'Percentage is required.'; const n = Number(v); if (isNaN(n)) return 'Percentage must be a number.'; if (n < 5.0 || n > 10.0) return 'Percentage must be between 5.0 and 10.0.'; return ''; }
    function calcAmount(q,p){ const qn = Number(q); const pn = Number(p); if (!isFinite(qn) || !isFinite(pn)) return ''; return Number((qn * pn * 7.5).toFixed(2)); }

    // Form row creation (removed helper text for amount)
    function createFormRow(prefill = {}) {
      const id = 'fr_' + (nextFormId++);
      const wrapper = document.createElement('div');
      wrapper.className = 'row-input';
      wrapper.dataset.formId = id;

      const serialCol = document.createElement('div'); serialCol.className = 'serial-badge'; serialCol.textContent = '‚Äî';

      const colId = document.createElement('div'); colId.className='field';
      const lblId = document.createElement('label'); lblId.textContent='ID';
      const inpId = document.createElement('input'); inpId.type='number'; inpId.min=0; inpId.max=21; inpId.step=1;
      inpId.value = (prefill.id !== undefined && prefill.id !== null) ? prefill.id : '';
      inpId.placeholder='e.g. 1';
      const errId = document.createElement('span'); errId.className='inline-error'; errId.style.display='none';
      colId.appendChild(lblId); colId.appendChild(inpId); colId.appendChild(errId);

      const colDate = document.createElement('div'); colDate.className='field';
      const lblDate = document.createElement('label'); lblDate.textContent='Date';
      const inpDate = document.createElement('input'); inpDate.type='date';
      if (prefill.date) inpDate.value = prefill.date; // internal ISO
      const errDate = document.createElement('span'); errDate.className='inline-error'; errDate.style.display='none';
      colDate.appendChild(lblDate); colDate.appendChild(inpDate); colDate.appendChild(errDate);

      const colQty = document.createElement('div'); colQty.className='field';
      const lblQty = document.createElement('label'); lblQty.textContent='Quantity';
      const inpQty = document.createElement('input'); inpQty.type='number'; inpQty.step='any';
      if (prefill.quantity !== undefined && prefill.quantity !== null) inpQty.value = prefill.quantity;
      const errQty = document.createElement('span'); errQty.className='inline-error'; errQty.style.display='none';
      colQty.appendChild(lblQty); colQty.appendChild(inpQty); colQty.appendChild(errQty);

      const colPct = document.createElement('div'); colPct.className='field';
      const lblPct = document.createElement('label'); lblPct.textContent='Percentage';
      const inpPct = document.createElement('input'); inpPct.type='number'; inpPct.step='any';
      if (prefill.percentage !== undefined && prefill.percentage !== null) inpPct.value = prefill.percentage;
      const errPct = document.createElement('span'); errPct.className='inline-error'; errPct.style.display='none';
      colPct.appendChild(lblPct); colPct.appendChild(inpPct); colPct.appendChild(errPct);

      const colAmt = document.createElement('div'); colAmt.className='field col-amount';
      const lblAmt = document.createElement('label'); lblAmt.textContent='Amount';
      const inpAmt = document.createElement('input'); inpAmt.type='text'; inpAmt.readOnly=true;
      if (prefill.amount !== undefined && prefill.amount !== null) inpAmt.value = formatNumber(prefill.amount);
      colAmt.appendChild(lblAmt); colAmt.appendChild(inpAmt);

      const colAct = document.createElement('div'); colAct.className='field col-actions';
      const btnRemove = document.createElement('button'); btnRemove.type='button'; btnRemove.className='ghost small'; btnRemove.textContent='Remove';
      btnRemove.addEventListener('click', () => { wrapper.remove(); updateFormSerials(); });
      colAct.appendChild(document.createElement('div')); colAct.appendChild(btnRemove);

      wrapper.appendChild(serialCol);
      wrapper.appendChild(colId);
      wrapper.appendChild(colDate);
      wrapper.appendChild(colQty);
      wrapper.appendChild(colPct);
      wrapper.appendChild(colAmt);
      wrapper.appendChild(colAct);

      function recalc(){ const q = inpQty.value; const p = inpPct.value; const a = calcAmount(q,p); inpAmt.value = a === '' ? '' : formatNumber(a); }
      inpQty.addEventListener('input', recalc);
      inpPct.addEventListener('input', recalc);

      inpId.addEventListener('blur', () => { const msg = validateId(inpId.value); if(msg){ errId.style.display='block'; errId.textContent = msg; } else { errId.style.display='none'; } });
      inpDate.addEventListener('blur', () => { const msg = validateDate(inpDate.value); if(msg){ errDate.style.display='block'; errDate.textContent = msg; } else { errDate.style.display='none'; } });
      inpQty.addEventListener('blur', () => { const msg = validateQty(inpQty.value); if(msg){ errQty.style.display='block'; errQty.textContent = msg; } else { errQty.style.display='none'; } });
      inpPct.addEventListener('blur', () => { const msg = validatePct(inpPct.value); if(msg){ errPct.style.display='block'; errPct.textContent = msg; } else { errPct.style.display='none'; } });

      wrapper._fields = { serialCol, inpId, inpDate, inpQty, inpPct, inpAmt, errId, errDate, errQty, errPct };
      formArea.insertBefore(wrapper, formArea.firstChild);
      updateFormSerials();
      return wrapper;
    }

    function updateFormSerials(){
      const nodes = Array.from(formArea.children);
      for(let i=0;i<nodes.length;i++){ const w = nodes[i]; if (w._fields && w._fields.serialCol) w._fields.serialCol.textContent = (i+1); }
    }

    // Map headers heuristics
    function mapHeaders(headerRow){
      const map = {};
      headerRow.forEach((h, idx) => {
        if (h == null) return;
        const key = String(h).trim().toLowerCase();
        if (!key) return;
        if (['id','identifier','ident','no','number'].includes(key)) map[idx]='id';
        else if (['date','day'].includes(key)) map[idx]='date';
        else if (['quantity','qty','q'].includes(key)) map[idx]='quantity';
        else if (['percentage','pct','percent','%'].includes(key)) map[idx]='percentage';
        else if (['amount','amt','value','total'].includes(key)) map[idx]='amount';
        else {
          if (key.includes('id')) map[idx]='id';
          else if (key.includes('date')) map[idx]='date';
          else if (key.includes('qty')||key.includes('quant')) map[idx]='quantity';
          else if (key.includes('pct')||key.includes('percent')||key.includes('%')) map[idx]='percentage';
          else if (key.includes('amt')||key.includes('amount')) map[idx]='amount';
        }
      });
      return map;
    }

    // Load workbook into preview; imported rows marked saved:false (highlighted)
    function loadWorkbookFileToTable(file){
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = e.target.result;
        let workbook;
        try { workbook = XLSX.read(data, { type:'array', cellDates:true, dateNF:'yyyy-mm-dd' }); }
        catch(err){ alert('Failed to read file: '+err); return; }
        const firstSheet = workbook.SheetNames[0];
        const ws = workbook.Sheets[firstSheet];
        if (!ws) { alert('No sheets found'); return; }
        const aoa = XLSX.utils.sheet_to_json(ws, { header:1, defval:null, raw:false, dateNF:'yyyy-mm-dd' });
        if (aoa.length === 0) { alert('Sheet empty'); return; }

        const header = aoa[0].map(h => h===null ? '' : String(h));
        let mapping = mapHeaders(header);
        if (!Object.values(mapping).includes('id') && aoa.length>1 && aoa[0].length>=4) {
          mapping = {0:'id',1:'date',2:'quantity',3:'percentage'}; if (aoa[0].length>=5) mapping[4]='amount';
        }

        const extracted = [], errors = [];
        for (let r=1;r<aoa.length;r++){
          const row = aoa[r];
          if (!row || row.every(c=>c===null||c==='')) continue;
          const obj = {};
          for (let c=0;c<row.length;c++){
            const field = mapping[c]; if(!field) continue;
            const cell = row[c];
            if (field==='id'){ const n=(cell===null)?null:Number(cell); obj.id = Number.isFinite(n)?Math.trunc(n):(cell!==null?String(cell).trim():null); }
            else if (field==='date'){ obj.date = parseDateToISO(cell); }
            else if (field==='quantity'){ const n=(cell===null)?null:Number(cell); obj.quantity = Number.isFinite(n)?n:(cell!==null?Number(String(cell).replace(/,/g,'')):null); }
            else if (field==='percentage'){ const raw = cell; let n=null; if (raw!==null){ const s = String(raw).replace('%','').replace(/,/g,'').trim(); n = Number(s); } obj.percentage = Number.isFinite(n)?n:null; }
            else if (field==='amount'){ const n=(cell===null)?null:Number(cell); obj.amount = Number.isFinite(n)?n:null; }
          }
          if ((obj.amount===null||obj.amount===undefined||obj.amount==='') && obj.quantity!=null && obj.percentage!=null) obj.amount = calcAmount(obj.quantity,obj.percentage);

          const eid = validateId(obj.id), ed = validateDate(obj.date), eq = validateQty(obj.quantity), ep = validatePct(obj.percentage);
          if (eid||ed||eq||ep){ errors.push({row:r+1, issues:[eid,ed,eq,ep].filter(Boolean).join(' | '), raw: obj}); continue; }
          extracted.push({ id: Number(obj.id), date: obj.date, quantity: Number(obj.quantity), percentage: Number(obj.percentage), amount: Number(obj.amount) || calcAmount(obj.quantity,obj.percentage), saved: false });
        }

        if (extracted.length) { rows = rows.concat(extracted); renderTable(); }
        let msg = `Imported ${extracted.length} valid row${extracted.length===1?'':'s'} from "${file.name}".`;
        if (errors.length){ msg += ` ${errors.length} row${errors.length===1?'':'s'} skipped.`; console.warn('Import skipped rows:', errors); }
        alert(msg);
        fileInfo.textContent = `Last imported: ${file.name} ‚Äî ${extracted.length} rows loaded, ${errors.length} skipped.`;

        // clear file input so same file can be re-picked
        fileInput.value = "";
      };
      reader.onerror = (err) => { alert('File read error: ' + err); };
      reader.readAsArrayBuffer(file);
    }

    // Gather & validate form rows (internal date iso)
    function gatherAndValidateAll(){
      const nodes = Array.from(formArea.children);
      const collected = []; let hasError=false;
      nodes.reverse(); // top->first
      for(const wrapper of nodes){
        const f = wrapper._fields;
        const idv = f.inpId.value;
        const datev = f.inpDate.value; // yyyy-mm-dd
        const qtyv = f.inpQty.value;
        const pctv = f.inpPct.value;
        const e1 = validateId(idv), e2 = validateDate(datev), e3 = validateQty(qtyv), e4 = validatePct(pctv);
        if (e1){ f.errId.style.display='block'; f.errId.textContent = e1; hasError=true; } else f.errId.style.display='none';
        if (e2){ f.errDate.style.display='block'; f.errDate.textContent = e2; hasError=true; } else f.errDate.style.display='none';
        if (e3){ f.errQty.style.display='block'; f.errQty.textContent = e3; hasError=true; } else f.errQty.style.display='none';
        if (e4){ f.errPct.style.display='block'; f.errPct.textContent = e4; hasError=true; } else f.errPct.style.display='none';
        const amt = calcAmount(qtyv,pctv);
        collected.push({ id: Number(idv), date: datev, quantity: Number(qtyv), percentage: Number(pctv), amount: amt===''?0:amt });
      }
      nodes.reverse();
      if (hasError) return { ok:false, data:null };
      return { ok:true, data:collected };
    }

    // Save: append form rows (as saved) AND mark any imported unsaved rows as saved
    function saveAllFormRows(){
      const res = gatherAndValidateAll();
      if (!res.ok){ alert('Please fix validation errors before saving.'); return; }
      // append form rows as saved
      const savedRows = res.data.map(r => ({...r, saved: true}));
      rows = rows.concat(savedRows);
      // mark all existing unsaved imported rows as saved
      rows = rows.map(r => ({ ...r, saved: true }));
      renderTable();
      clearForm();
    }

    // Render table; unsaved rows highlighted
    function renderTable(){
      tableHead.innerHTML = '';
      const headRow = document.createElement('tr');
      ['S.No','ID','Date','Quantity','Percentage','Amount','Actions'].forEach(h => { const th = document.createElement('th'); th.textContent = h; headRow.appendChild(th); });
      tableHead.appendChild(headRow);

      tableBody.innerHTML = '';
      rows.forEach((r, idx) => {
        const tr = document.createElement('tr');
        if (!r.saved) tr.classList.add('unsaved-row');
        const tdSerial = document.createElement('td'); tdSerial.textContent = idx+1; tr.appendChild(tdSerial);
        const tdId = document.createElement('td'); tdId.textContent = r.id; tr.appendChild(tdId);
        const tdDate = document.createElement('td'); tdDate.textContent = displayDateFromISO(r.date); tr.appendChild(tdDate);
        const tdQty = document.createElement('td'); tdQty.textContent = formatNumber(r.quantity); tr.appendChild(tdQty);
        const tdPct = document.createElement('td'); tdPct.textContent = formatNumber(r.percentage); tr.appendChild(tdPct);
        const tdAmt = document.createElement('td'); tdAmt.textContent = formatNumber(r.amount); tr.appendChild(tdAmt);

        const tdAct = document.createElement('td'); tdAct.className='actions';
        const btnEdit = document.createElement('button'); btnEdit.className='ghost small'; btnEdit.textContent='Edit';
        const btnDelete = document.createElement('button'); btnDelete.className='ghost small'; btnDelete.textContent='Delete';
        const btnCopy = document.createElement('button'); btnCopy.className='ghost small'; btnCopy.textContent='Copy';

        btnCopy.addEventListener('click', () => {
          createFormRow({ id: r.id, date: r.date, quantity: r.quantity, percentage: r.percentage, amount: r.amount });
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        btnDelete.addEventListener('click', () => {
          if (!confirm('Delete this row?')) return;
          rows.splice(idx,1); renderTable();
        });

        btnEdit.addEventListener('click', () => {
          createFormRow({ id: r.id, date: r.date, quantity: r.quantity, percentage: r.percentage, amount: r.amount });
          rows.splice(idx,1); renderTable();
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        tdAct.appendChild(btnEdit); tdAct.appendChild(btnDelete); tdAct.appendChild(btnCopy);
        tr.appendChild(tdAct);
        tableBody.appendChild(tr);
      });
      rowsCount.textContent = `${rows.length} row${rows.length===1?'':'s'}`;
    }

    function clearForm(){ formArea.innerHTML=''; nextFormId=1; createFormRow(); fileInfo.textContent=''; }

    // Export: Date column exported as dd-mm-yyyy strings
    function downloadXLSX(){
      const aoa = []; aoa.push(['ID','Date','Quantity','Percentage','Amount']);
      rows.forEach(r => aoa.push([r.id, displayDateFromISO(r.date), r.quantity, r.percentage, r.amount]));
      const ws = XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols'] = [{wch:6},{wch:12},{wch:12},{wch:12},{wch:14}];
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Sheet1'); XLSX.writeFile(wb, 'table-data.xlsx');
    }

    // Init and events
    renderTable(); clearForm();

    btnAddRow.addEventListener('click', () => { createFormRow(); updateFormSerials(); });
    btnClearForm.addEventListener('click', () => { if (!confirm('Clear all form rows?')) return; clearForm(); });
    btnSave.addEventListener('click', saveAllFormRows);
    btnDeleteAll.addEventListener('click', () => { if (!confirm('Delete ALL preview rows? This cannot be undone.')) return; rows = []; renderTable(); });
    btnDownload.addEventListener('click', () => { if (rows.length === 0) { if (!confirm('No rows available. Download header-only file?')) return; } downloadXLSX(); });

    fileInput.addEventListener('change', (evt) => {
      const f = evt.target.files && evt.target.files[0]; if (!f) return; loadWorkbookFileToTable(f);
    });

    // drag-drop supported
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop', (e) => { e.preventDefault(); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if (f) loadWorkbookFileToTable(f); });
  </script>
</body>
</html>
